<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">

  <script type="text/javascript" color="0,0,255" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="JR7w5GBLdT" />








  <meta name="baidu-site-verification" content="true" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Linux,c," />





  <link rel="alternate" href="/atom.xml" title="Ele Ztian's Blog" type="application/atom+xml" />






<meta name="description" content="概念 Linux中的信号（signal)也叫 “软中断信号”，用于通知进程发生的异步事件。 早期信号的处理方法： 指定处理函数，通过改函数中断处理 eg. signal(SIGALARM, handler)； 忽略该信号 eg. signal(SIGALARM, SIG_IGN； 对该信号的处理保留系统默认（缺省操作），eg. signal(SIGALARM, SIG_DFL),  大部分信号的缺">
<meta name="keywords" content="Linux,c">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 信号机制">
<meta property="og:url" content="http://www.eleztian.xyz/2017/10/Linux-信号机制/index.html">
<meta property="og:site_name" content="Ele Ztian&#39;s Blog">
<meta property="og:description" content="概念 Linux中的信号（signal)也叫 “软中断信号”，用于通知进程发生的异步事件。 早期信号的处理方法： 指定处理函数，通过改函数中断处理 eg. signal(SIGALARM, handler)； 忽略该信号 eg. signal(SIGALARM, SIG_IGN； 对该信号的处理保留系统默认（缺省操作），eg. signal(SIGALARM, SIG_DFL),  大部分信号的缺">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-10-03T03:51:06.071Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux 信号机制">
<meta name="twitter:description" content="概念 Linux中的信号（signal)也叫 “软中断信号”，用于通知进程发生的异步事件。 早期信号的处理方法： 指定处理函数，通过改函数中断处理 eg. signal(SIGALARM, handler)； 忽略该信号 eg. signal(SIGALARM, SIG_IGN； 对该信号的处理保留系统默认（缺省操作），eg. signal(SIGALARM, SIG_DFL),  大部分信号的缺">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.eleztian.xyz/2017/10/Linux-信号机制/"/>





  <title>Linux 信号机制 | Ele Ztian's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband">
     <a href="https://github.com/eleztian"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
    </div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ele Ztian's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Essay</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.eleztian.xyz/2017/10/Linux-信号机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ele Ztian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ele Ztian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Linux 信号机制</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-03T11:32:40+08:00">
                2017-10-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,524
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><ul>
<li>Linux中的信号（signal)也叫 <strong>“软中断信号”</strong>，用于通知进程发生的异步事件。</li>
<li>早期信号的处理方法：<ol>
<li>指定处理函数，通过改函数中断处理 eg. signal(SIGALARM, handler)；</li>
<li>忽略该信号 eg. signal(SIGALARM, SIG_IGN；</li>
<li>对该信号的处理保留系统默认（缺省操作），eg. signal(SIGALARM, SIG_DFL),  大部分信号的缺省操作是终止进程；</li>
</ol>
</li>
<li>多信号处理<ol>
<li>SIG_x 打断 SIG_y的处理函数：</li>
<li>SIG_x 打断 SIG_x的处理函数：<br> a. 递归，调用同一个处理函数；<br> b. 忽略第二个信号；<br> c. 阻塞第二个信号直到第一个信号处理完毕；</li>
</ol>
</li>
<li>早期信号处理机制的问题<ol>
<li>捕鼠器问题（不可靠的信号）：<br> 一个信号表示一个具有破坏性的事情发生并被捕获，当信号或老鼠被捕后，捕鼠器失效，需要重置捕鼠器后才可以继续工作。然而重置捕鼠器是需要一定时间的及时时间很短，这个助理间隙就使得信号处理变得不可靠。</li>
<li>不知道信号被发送的原因：<br> 早期模型只是只是告诉处理器，处理函数被调用有什么信号引起，而没有说明产生这个信号的原因。</li>
<li>处理函数中不能安全的阻塞其他消息：</li>
</ol>
</li>
</ul>
<blockquote>
<p>在进程表的表项中有一个软中断信号域，该域中每一位对应一个信号，当有信号发送给进程时，对应位置位。由此可以看出，进程对不同的信号可以同时保留，但对于同一个信号，进程并不知道在处理之前来过多少个。</p>
</blockquote>
<h1 id="编程"><a href="#编程" class="headerlink" title="编程"></a>编程</h1><ul>
<li>signal.h</li>
</ul>
<ol>
<li><p>int signal(int signum, void (*action)(int));</p>
<pre><code>signum: 信号
action: 如何响应 （SIG_IGN, SIG_DFL, 函数名（int signum））
返回 -1 失败
</code></pre></li>
<li><p>int sigaction(int signum, const struct sigaction <em>action,struct sigaction </em>prevation)；</p>
</li>
</ol>
<hr>
<p>man 手册查询 man 2 sigaction<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> &#123;</span></div><div class="line">    <span class="keyword">void</span>     (*sa_handler)(<span class="keyword">int</span>);</div><div class="line">    <span class="keyword">void</span>     (*sa_sigaction)(<span class="keyword">int</span>, <span class="keyword">siginfo_t</span> *, <span class="keyword">void</span> *);</div><div class="line">    <span class="keyword">sigset_t</span>   sa_mask;</div><div class="line">    <span class="keyword">int</span>        sa_flags;</div><div class="line">    <span class="keyword">void</span>     (*sa_restorer)(<span class="keyword">void</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>其中 sa_handle 和 sa_sigaction 只能有一个。<br>sa_sigaction 相比较于sa_handle 可以获取更多的信息通过struct siginfo_t传递，如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">siginfo_t</span> &#123;</span></div><div class="line">          <span class="keyword">int</span>      si_signo;    <span class="comment">/* Signal number */</span></div><div class="line">          <span class="keyword">int</span>      si_errno;    <span class="comment">/* An errno value */</span></div><div class="line">          <span class="keyword">int</span>      si_code;     <span class="comment">/* Signal code */</span></div><div class="line">          <span class="keyword">int</span>      si_trapno;   <span class="comment">/* Trap number that caused</span></div><div class="line"><span class="comment">                                   hardware-generated signal</span></div><div class="line"><span class="comment">                                   (unused on most architectures) */</span></div><div class="line">          <span class="keyword">pid_t</span>    si_pid;      <span class="comment">/* Sending process ID */</span></div><div class="line">          <span class="keyword">uid_t</span>    si_uid;      <span class="comment">/* Real user ID of sending process */</span></div><div class="line">          <span class="keyword">int</span>      si_status;   <span class="comment">/* Exit value or signal */</span></div><div class="line">          <span class="keyword">clock_t</span>  si_utime;    <span class="comment">/* User time consumed */</span></div><div class="line">          <span class="keyword">clock_t</span>  si_stime;    <span class="comment">/* System time consumed */</span></div><div class="line">          <span class="keyword">sigval_t</span> si_value;    <span class="comment">/* Signal value */</span></div><div class="line">          <span class="keyword">int</span>      si_int;      <span class="comment">/* POSIX.1b signal */</span></div><div class="line">          <span class="keyword">void</span>    *si_ptr;      <span class="comment">/* POSIX.1b signal */</span></div><div class="line">          <span class="keyword">int</span>      si_overrun;  <span class="comment">/* Timer overrun count; POSIX.1b timers */</span></div><div class="line">          <span class="keyword">int</span>      si_timerid;  <span class="comment">/* Timer ID; POSIX.1b timers */</span></div><div class="line">          <span class="keyword">void</span>    *si_addr;     <span class="comment">/* Memory location which caused fault */</span></div><div class="line">          <span class="keyword">int</span>      si_band;     <span class="comment">/* Band event */</span></div><div class="line">          <span class="keyword">int</span>      si_fd;       <span class="comment">/* File descriptor */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>sa_mask: 允许设置信号处理函数执行时所需要阻塞的信号。<br>sa_flags: 修改信号处理函数执行时的默认行为。</p>
<blockquote>
<p>sa_flags specifies a set of flags which modify the behavior of the signal.  It isformed by the bitwise OR of zero or more of the following:</p>
</blockquote>
<pre><code>SA_NOCLDSTOP
       If signum is SIGCHLD, do not receive notification when child processes
       stop  (i.e.,  when  they  receive  one of SIGSTOP, SIGTSTP, SIGTTIN or
       SIGTTOU) or resume (i.e., they receive SIGCONT) (see  wait(2)).   This
       flag is only meaningful when establishing a handler for SIGCHLD.
SA_NOCLDWAIT (Since Linux 2.6)
       If signum is SIGCHLD, do not transform children into zombies when they
       terminate.  See also waitpid(2).  This flag is  only  meaningful  when
       establishing a handler for SIGCHLD, or when setting that signal’s dis-
       position to SIG_DFL.
       If the SA_NOCLDWAIT flag  is  set  when  establishing  a  handler  for
       SIGCHLD,  POSIX.1  leaves  it  unspecified whether a SIGCHLD signal is
       generated when a child process terminates.  On Linux, a SIGCHLD signal
       is generated in this case; on some other implementations, it is not.
SA_NODEFER
       Do not prevent the signal from being received from within its own sig-
       nal handler.  This flag is only meaningful when establishing a  signal
       handler.   SA_NOMASK  is  an  obsolete,  non-standard synonym for this
       flag.
SA_ONSTACK
       Call the signal handler on  an  alternate  signal  stack  provided  by
       sigaltstack(2).   If  an alternate stack is not available, the default
       stack will be used.  This flag is only meaningful when establishing  a
       signal handler.
SA_RESETHAND
       Restore the signal action to the default state once the signal handler
       has been called.  This flag is only  meaningful  when  establishing  a
       signal  handler.   SA_ONESHOT is an obsolete, non-standard synonym for
       this flag.
SA_RESTART
       Provide behavior compatible with BSD signal semantics by  making  cer-
       tain system calls restartable across signals.  This flag is only mean-
       ingful when establishing a signal handler.  See signal(7) for  a  dis-
       cussion of system call restarting.
SA_SIGINFO (since Linux 2.2)
       The  signal  handler  takes  3  arguments,  not  one.   In  this case,
       sa_sigaction should be set instead of sa_handler.  This flag  is  only
       meaningful when establishing a signal handler.
</code></pre><h1 id="常见问题："><a href="#常见问题：" class="headerlink" title="常见问题："></a>常见问题：</h1><ol>
<li>由于信号处理函数是异步执行的，那么我们就无法预知它的执行时间，因此就存在数据共享问题：<br> a. 编译器优化导致处理函数中对变量的修改无法让主函数感知到：<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> exit_flag = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hdl</span> <span class="params">(<span class="keyword">int</span> sig)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    exit_flag = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></div><div class="line"></div><div class="line">    <span class="built_in">memset</span> (&amp;act, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(act));</div><div class="line">    act.sa_handler = &amp;hdl;</div><div class="line">    <span class="keyword">if</span> (sigaction(SIGTERM, &amp;act, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</div><div class="line">        perror (<span class="string">"sigaction"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (!exit_flag)</div><div class="line">        ;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>对上面的代码进行gcc O2级别优化，程序可以正常退出，但是如果采用O3级别优化，那么程序将不能退出。<br>    因为O2级别的优化时，编译器发现在程序中存在循环读取某一变量时，编译器为了提高效率为将这个变量直接装入寄存器，那么他读取数据时就是直接从寄存器读取而并不是从内存中，这就导致当信号处理函数修改这个变量后，主程序无法感知。解决办法是对变量夹volatile关键字，使其每次都从内存中读取数据。</p>
<p>其他问题后面遇见了再完善。</p>
<h1 id="特殊信号处理"><a href="#特殊信号处理" class="headerlink" title="特殊信号处理"></a>特殊信号处理</h1><blockquote>
<p>SIGCHLD信号</p>
</blockquote>
<p>一般我们不使用这个信号，它的存在作用主要在于清理僵尸进程。<br><strong><em>僵尸进程： 我们知道进程在执行exit()时是释放打开的文件等资源，但在linux中这个进程信息仍在存在进程表中没有被清除，这就是僵尸进程。我们知道进程ID等资源是有限的当僵尸进程过多就会导致无法创建新进程。</em></strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sigchld_handle</span> <span class="params">(<span class="keyword">int</span> sig)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">/* 等待所有已经退出的子进程。</span></div><div class="line"><span class="comment">     * 这里使用非阻塞的调用以防止子进程在代码其他地方被清理。 */</span></div><div class="line">    <span class="keyword">while</span> (waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>SIGBUS信号</p>
</blockquote>
<p>SIGBUS信号通常是访问被映射的内存时，无法映射到对应文件。<strong><em>映射（mmap(2)): 内存映射，简而言之就是将用户空间的一段内存区域映射到内核空间，映射成功后，用户对这段内存区域的修改可以直接反映到内核空间，同样，内核空间对这段区域的修改也直接反映用户空间。那么对于内核空间&lt;–&gt;用户空间两者之间需要大量数据传输等操作的话效率是非常高的。</em></strong><br>在这时进程缺省是直接退出，但是我们也是可以对其进行处理的。可以使用sigsetjmp(3)和siglohgjmp(3)跳转到错误的地方，让成宿继续执行。</p>
<pre><code>DESCRIPTION
   setjmp()  and  longjmp(3) are useful for dealing with errors and inter-
   rupts encountered in a low-level subroutine  of  a  program.   setjmp()
   saves the stack context/environment in env for later use by longjmp(3).
   The stack context will be invalidated  if  the  function  which  called
   setjmp() returns.
   sigsetjmp()  is similar to setjmp().  If, and only if, savesigs is non-
   zero, the process’s current signal mask is saved in  env  and  will  be
   restored if a siglongjmp(3) is later performed with this env.
</code></pre><p>但是使用它们的时候一定要小心死锁的产生（我并不会用。。。）</p>
<blockquote>
<p>SIGSEGV信号</p>
</blockquote>
<p>SIGSEGV 段错误信号（这个倒是常见）, 谁然可以处理但是意义不大。 一种使用场景是在因为写保护而发生SIGEGV时可以通过siginfo_t 得到产出错误的原因从而使用mprotect(2)去除写保护。（没用过）<br>还有一种是，由于栈空间不足产生，可以使用sigaltstack(2)函数定义独立的栈空间。</p>
<blockquote>
<p>SIGABRT信号</p>
</blockquote>
<p><strong><em>abort(3)函数:用于终止一个进程。该函数先发送SIGABRT信号，如果该信号被忽略或该信号的处理函数正常返回，它会将信号处理函数重置为默认方式，并重发SIGABRT信号，使进程退出。</em></strong><br>因此处理SIGABRT信号可以在进程结束前做一些事情。<br>产生SIGABRT的一般原因：</p>
<ol>
<li>对野指针操作；</li>
<li>对一个地址free()多次；</li>
<li>assert失败；</li>
<li>堆越界</li>
</ol>
<h1 id="信号的使用"><a href="#信号的使用" class="headerlink" title="信号的使用"></a>信号的使用</h1><ol>
<li>Fork(), Fork()复制一个子进程，这个复制并不会复制父进程的信号队列，子进程会单独创建一个空信号队列。但是子进程会继承父进程所有的信号处理函数和信号阻塞状态。如果父进程以及完成了对信号的设置那么子进程无需再次设置。</li>
<li>pthread线程，一个进程下的所有线程有相同的进程ID（PID），向多线程发送信号的情况：<br> a. 向进程发送信号：<br> b. 向特定线程发送信号：</li>
<li><p>信号发送</p>
<ol>
<li>键盘交互（C+C(SIGINT), C+(SIGQUIT), C+Z(SIGSTOP)）</li>
<li>kill(pid_t pid, int sig),其中pid:<ul>
<li>0:目标为当前进程组的所有进程;</li>
<li>-1： 目标是所有的（可以发送信号）进程;</li>
<li>&lt;-1: 目标是进程ID为-ID的进程组；</li>
</ul>
</li>
<li>向进程自身发送信号：raise(3), abort（3）：<ul>
<li>raise(int sig):可以向进程发送指定信号（在多线程中只能想当前线程发送信号）</li>
<li>abort(): 发送SIFABRT信号——&gt;重置该信号-&gt;发送SIGABRT信号-&gt;程序终止</li>
</ul>
</li>
<li>sigqueue(pid_t pid, int sig, const union sigval value)，与kill类似，多了一个参数可以负载信息，通过siginfo_t获取这个参数。</li>
</ol>
</li>
<li><p>信号阻塞<br>阻塞信号，加入信号队列。可以防止当前程序被打断，防止信号竞争。实现方式：</p>
<ul>
<li>signal(int signum, sighandler_t handler), 将handler设置为SIG_IGN实现阻塞，该方式已经废弃。</li>
<li>sigprocmask(2), 它提供了更多的参数。如下例：<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> got_signal = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hdl</span> <span class="params">(<span class="keyword">int</span> sig)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    got_signal = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">sigset_t</span> mask;</div><div class="line">    <span class="keyword">sigset_t</span> orig_mask;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></div><div class="line"></div><div class="line">    <span class="built_in">memset</span> (&amp;act, <span class="number">0</span>, <span class="keyword">sizeof</span>(act));</div><div class="line">    act.sa_handler = hdl;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sigaction(SIGTERM, &amp;act, <span class="number">0</span>)) &#123;</div><div class="line">        perror (<span class="string">"sigaction"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sigemptyset (&amp;mask);</div><div class="line">    sigaddset (&amp;mask, SIGTERM);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sigprocmask(SIG_BLOCK, &amp;mask, &amp;orig_mask) &lt; <span class="number">0</span>) &#123;</div><div class="line">        perror (<span class="string">"sigprocmask"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sleep (<span class="number">10</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sigprocmask(SIG_SETMASK, &amp;orig_mask, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</div><div class="line">        perror (<span class="string">"sigprocmask"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sleep (<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (got_signal)</div><div class="line">        <span class="built_in">puts</span> (<span class="string">"Got signal"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="Ele Ztian 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Ele Ztian 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
            <a href="/tags/c/" rel="tag"># c</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/文件-IO/" rel="next" title="文件 IO">
                <i class="fa fa-chevron-left"></i> 文件 IO
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          
  
     
       <div id="gitment-container"></div>
     
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/photo.jpg"
                alt="Ele Ztian" />
            
              <p class="site-author-name" itemprop="name">Ele Ztian</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/eleztian" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:eleztian@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://stackoverflow.com/eleztian" target="_blank" title="StackOverflow">
                    
                      <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概念"><span class="nav-number">1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编程"><span class="nav-number">2.</span> <span class="nav-text">编程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常见问题："><span class="nav-number">3.</span> <span class="nav-text">常见问题：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#特殊信号处理"><span class="nav-number">4.</span> <span class="nav-text">特殊信号处理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#信号的使用"><span class="nav-number">5.</span> <span class="nav-text">信号的使用</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ele Ztian</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">5.0k</span>
  
</div>
<div class="powered-by">
  <i class="fa fa-user-md"></i>
  <span id="busuanzi_container_site_uv">本站访客数:
    <span id="busuanzi_value_site_uv"></span>
    <span class="post-meta-divider">|</span>
  </span>
</div>

  <div class="powered-by">由 <a class="theme-link" href="http://hexo.io" rel="external nofollow">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>

<p>
  Hosted by 
  <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a> 
  <span class="post-meta-divider">|</span>
  <a href="https://github.com" style="font-weight: bold">Github</a>
  </p>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








     
     
     
     
     <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
     <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
     
         <script type="text/javascript">
             var gitment = new Gitment({
                id: document.location.href, 
                 owner: 'eleztian',
                 repo: 'eleztian.github.io',
                 oauth: {
                     client_id: 'ee3023fe6180e590dc31',
                     client_secret: 'bf96b94923293ced5e01a9584682398880f121dd',
                 }});
             gitment.render('gitment-container');
         </script>
     
 
  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
